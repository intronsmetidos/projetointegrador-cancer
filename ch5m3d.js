var element=new Array();var molecule=new Array();document.getElementById("molfile").addEventListener("change",MyFileReader,false);function MyFileReader(c){var a;var d=c.target.files[0];if(d){var b=new FileReader();b.onload=function(e){var g=e.target.result;var f=g.split("\n");readXYZfile(f);centerMolecule("molcanvas");drawMolecule("molcanvas")};b.readAsText(d)}else{alert("Failed to load file")}}function loadMolecule(){var a;addAtom(6,0,0,0);addAtom(1,0.874,0.618,0);addAtom(1,-0.874,0.618,0);addAtom(1,0,-0.618,0.874);addAtom(1,0,-0.618,-0.874);addBond(1,2);addBond(1,3);addBond(1,4);addBond(1,5)}function initialize(){var a=document.getElementById("molcanvas");delMolecule();initElements();viewmode();a.onmousedown=MouseDown;document.onmouseup=MouseUp;document.onmousemove=MouseMove;a.addEventListener("mousewheel",MouseWheel,false);a.addEventListener("DOMMouseScroll",MouseWheel,false);a.addEventListener("touchstart",MouseDown);a.addEventListener("touchend",MouseUp);a.addEventListener("touchmove",MouseMove);if(typeof molecule=="undefined"){delMolecule()}if(molecule[0].numatoms<1){delMolecule();loadMolecule();formula();centerMolecule("molcanvas")}drawMolecule("molcanvas");pickClouds(4);pickElem("C")}function elementObject(){this.symbol="?";this.block="?";this.valence=0;this.mass=0;this.radius=0;this.EN=0;this.color="rgb(88,88,88)";this.gradient="rgb(88,88,88)";this.label="rgb(255,255,255)"}function addElement(a,g,d,b,m,h,c,e,n,l){var o;element[a]=new elementObject();element[a].symbol=g;element[a].block=d;element[a].valence=b;element[a].mass=m;(h<=0)?o=0.1:o=h/100;element[a].radius=o;element[a].color="rgb("+c+","+e+","+n+")";element[a].gradient="rgb("+Math.floor(c/2)+","+Math.floor(e/2)+","+Math.floor(n/2)+")";var f=c+e+n;element[a].label=(f>384)?"rgb(0,0,0)":"rgb(255,255,255)";element[a].EN=l}function initElements(){addElement(0,"X","s",0,0,0,0,0,0,0);addElement(1,"H","s",1,1.0079,31,255,255,255,2.2);addElement(2,"He","s",2,4.0026,28,217,255,255,0);addElement(3,"Li","s",1,6.941,128,204,128,255,0.98);addElement(4,"Be","s",2,9.0122,96,194,255,0,1.57);addElement(5,"B","p",3,10.811,84,255,181,181,2.04);addElement(6,"C","p",4,12.0107,76,144,144,144,2.55);addElement(7,"N","p",5,14.0067,71,48,80,248,3.04);addElement(8,"O","p",6,15.9994,66,255,13,13,3.44);addElement(9,"F","p",7,18.9984,57,144,224,80,3.98);addElement(10,"Ne","p",8,20.1797,58,179,227,245,0);addElement(11,"Na","s",1,22.9897,166,171,92,242,0.93);addElement(12,"Mg","s",2,24.305,141,138,255,0,1.31);addElement(13,"Al","p",3,26.9815,121,191,166,166,1.61);addElement(14,"Si","p",4,28.0855,111,240,200,160,1.9);addElement(15,"P","p",5,30.9738,107,255,128,0,2.19);addElement(16,"S","p",6,32.065,105,255,255,48,2.58);addElement(17,"Cl","p",7,35.453,102,31,240,31,3.16);addElement(18,"Ar","p",8,39.948,106,128,209,227,0);addElement(19,"K","s",1,39.0983,203,143,64,212,0.82);addElement(20,"Ca","s",2,40.078,176,61,255,0,1);addElement(21,"Sc","d",3,44.9559,170,230,230,230,1.36);addElement(22,"Ti","d",4,47.867,160,191,194,199,1.54);addElement(23,"V","d",5,50.9415,153,166,166,171,1.63);addElement(24,"Cr","d",6,51.9961,139,138,153,199,1.66);addElement(25,"Mn","d",7,54.938,139,156,122,199,1.55);addElement(26,"Fe","d",8,55.845,132,224,102,51,1.83);addElement(27,"Co","d",9,58.9332,126,240,144,160,1.88);addElement(28,"Ni","d",10,58.6934,124,80,208,80,1.91);addElement(29,"Cu","d",11,63.546,132,200,128,51,1.9);addElement(30,"Zn","d",2,65.39,122,125,128,176,1.65);addElement(31,"Ga","p",3,69.723,122,194,143,143,1.81);addElement(32,"Ge","p",4,72.64,120,102,143,143,2.01);addElement(33,"As","p",5,74.9216,119,189,128,227,2.18);addElement(34,"Se","p",6,78.96,120,255,161,0,2.55);addElement(35,"Br","p",7,79.904,120,166,41,41,2.96);addElement(36,"Kr","p",8,83.8,116,92,184,209,3);addElement(37,"Rb","s",1,85.4678,220,112,46,176,0.82);addElement(38,"Sr","s",2,87.62,195,0,255,0,0.95);addElement(39,"Y","d",3,88.9059,190,148,255,255,1.22);addElement(40,"Zr","d",4,91.224,175,148,224,224,1.33);addElement(41,"Nb","d",5,92.9064,164,115,194,201,1.6);addElement(42,"Mo","d",6,95.94,154,84,181,181,2.16);addElement(43,"Tc","d",7,98,147,59,158,158,1.9);addElement(44,"Ru","d",8,101.07,146,36,143,143,2.2);addElement(45,"Rh","d",9,102.9055,142,10,125,140,2.28);addElement(46,"Pd","d",10,106.42,139,0,105,133,2.2);addElement(47,"Ag","d",11,107.8682,145,192,192,192,1.93);addElement(48,"Cd","d",2,112.411,144,255,217,143,1.69);addElement(49,"In","p",3,114.818,142,166,117,115,1.78);addElement(50,"Sn","p",4,118.71,139,102,128,128,1.96);addElement(51,"Sb","p",5,121.76,139,158,99,181,2.05);addElement(52,"Te","p",6,127.6,138,212,122,0,2.1);addElement(53,"I","p",7,126.9045,139,148,0,148,2.66);addElement(54,"Xe","p",8,131.293,140,66,158,176,2.6);addElement(55,"Cs","s",1,132.9055,244,87,23,143,0.79);addElement(56,"Ba","s",2,137.327,215,0,201,0,0.89);addElement(57,"La","d",3,138.9055,207,112,212,255,1.1);addElement(58,"Ce","f",4,140.116,204,255,255,199,1.12);addElement(59,"Pr","f",5,140.9077,203,217,255,199,1.13);addElement(60,"Nd","f",6,144.24,201,199,255,199,1.14);addElement(61,"Pm","f",7,145,199,163,255,199,0);addElement(62,"Sm","f",8,150.36,198,143,255,199,1.17);addElement(63,"Eu","f",9,151.964,198,97,255,199,0);addElement(64,"Gd","f",10,157.25,196,69,255,199,1.2);addElement(65,"Tb","f",11,158.9253,194,48,255,199,0);addElement(66,"Dy","f",12,162.5,192,31,255,199,1.22);addElement(67,"Ho","f",13,164.9303,192,0,255,156,1.23);addElement(68,"Er","f",14,167.259,189,0,230,117,1.24);addElement(69,"Tm","f",15,168.9342,190,0,212,82,1.25);addElement(70,"Yb","f",16,173.04,187,0,191,56,0);addElement(71,"Lu","f",17,174.967,187,0,171,36,1.27);addElement(72,"Hf","d",4,178.49,175,77,194,255,1.3);addElement(73,"Ta","d",5,180.9479,170,77,166,255,1.5);addElement(74,"W","d",6,183.84,162,33,148,214,2.36);addElement(75,"Re","d",7,186.207,151,38,125,171,1.9);addElement(76,"Os","d",8,190.23,144,38,102,150,2.2);addElement(77,"Ir","d",9,192.217,141,23,84,135,2.2);addElement(78,"Pt","d",10,195.078,136,208,208,224,2.28);addElement(79,"Au","d",11,196.9665,136,255,209,35,2.54);addElement(80,"Hg","d",2,200.59,132,184,184,208,2);addElement(81,"Tl","p",3,204.3833,145,166,84,77,1.62);addElement(82,"Pb","p",4,207.2,146,87,89,97,2.33);addElement(83,"Bi","p",5,208.9804,148,158,79,181,2.02);addElement(84,"Po","p",6,209,140,171,92,0,2);addElement(85,"At","p",7,210,150,117,79,69,2.2);addElement(86,"Rn","p",8,222,150,66,130,150,0);addElement(87,"Fr","s",1,223,260,66,0,102,0.7);addElement(88,"Ra","s",2,226,221,0,125,0,0.9);addElement(89,"Ac","d",3,227,215,112,171,250,1.1);addElement(90,"Th","f",4,232.0381,206,0,186,255,1.3);addElement(91,"Pa","f",5,231.0359,200,0,161,255,1.5);addElement(92,"U","f",6,238.0289,196,0,143,255,1.38);addElement(93,"Np","f",7,237,190,0,128,255,1.36);addElement(94,"Pu","f",8,244,187,0,107,255,1.28);addElement(95,"Am","f",9,243,180,84,92,242,1.3);addElement(96,"Cm","f",10,247,169,120,92,227,1.3);addElement(97,"Bk","f",11,247,168,138,79,227,1.3);addElement(98,"Cf","f",12,251,168,161,54,212,1.3);addElement(99,"Es","f",13,252,165,179,31,212,1.3);addElement(100,"Fm","f",14,257,167,179,31,186,1.3);addElement(101,"Md","f",15,258,173,179,13,166,1.3);addElement(102,"No","f",16,259,176,189,13,135,1.3);addElement(103,"Lr","f",17,262,161,199,0,102,0);addElement(104,"Rf","d",4,267,157,204,0,89,0);addElement(105,"Db","d",5,268,149,209,0,79,0);addElement(106,"Sg","d",6,269,143,217,0,69,0);addElement(107,"Bh","d",7,270,141,224,0,56,0);addElement(108,"Hs","d",8,269,134,230,0,46,0);addElement(109,"Mt","d",9,278,129,235,0,38,0);addElement(110,"Ds","d",10,281,0,0,0,28,0);addElement(111,"Rg","d",11,281,0,0,0,28,0);addElement(112,"Cn","d",12,285,0,0,0,28,0);addElement(113,"Uut","p",3,286,0,0,0,28,0);addElement(114,"Fl","p",4,289,0,0,0,28,0);addElement(115,"Uup","p",5,288,0,0,0,28,0);addElement(116,"Lv","p",6,293,0,0,0,28,0);addElement(117,"Uus","p",7,294,0,0,0,28,0);addElement(118,"Uuo","p",8,294,0,0,0,28,0)}function atomObject(){var a=8;this.atomicnumber=0;this.x=0;this.y=0;this.z=0;this.bonds=Array(a);this.charge=0}function molObject(){this.numatoms=0;this.AtomScale=1;this.showlabels=1;this.showcharges=0}function readXYZfile(u){var e,d,n;var c,o,m,l;var t,s,p,a;var q;var g;var f=new Array();var h=new Array();var b=document.getElementById("qcinfo");delMolecule();n=parseInt(u[0].replace(/\s+/,""));if(isNaN(n)){b.value+="*** ERROR Reading XYZ file. ***\n";return}h=u[1];h=h.replace(/\s+$/,"");b.value=h+"\n";b.value+="Looking for "+n+" atoms.\n";for(e=2;e<(n+2);e++){f=u[e].replace(/\s+/g," ").replace(/^\s+/,"").split(" ");c=lookupSymbol(f[0]);if((c<1)||(c>118)){b.value+="*** ERROR Reading XYZ file. ***\n";return}o=parseFloat(f[1]);m=parseFloat(f[2]);l=parseFloat(f[3]);addAtom(c,o,m,l);b.value+=" "+f[0]+"("+c+")  "+o+", "+m+", "+l+"\n"}for(e=1;e<n;e++){for(d=e+1;d<=n;d++){q=1.2*(element[molecule[e].atomicnumber].radius+element[molecule[d].atomicnumber].radius);t=molecule[e].x-molecule[d].x;s=molecule[e].y-molecule[d].y;p=molecule[e].z-molecule[d].z;a=Math.sqrt(t*t+s*s+p*p);if(a<=q){addBond(e,d)}}}b.value+="Finished reading XYZ input file.\n"}function readMOLfile(a,t){var g,f;var p,o,n;var l,h;var d,e;var m=new Array();var q=escape(a.name);var b=document.getElementById("qcinfo");b.value="File Name = "+q;b.value+="\nFile Type = "+a.type;b.value+="\nFile Size = "+a.size;delMolecule();m=t[0];m=m.replace(/\s+$/,"");var s=parseFloat(t[3].substr(0,3));var c=parseFloat(t[3].substr(3,3));b.value+="\n\n"+m;b.value+="\n"+s+" atoms and "+c+" bonds.";f=s+4;for(g=4;g<f;g++){p=parseFloat(t[g].substr(0,10));o=parseFloat(t[g].substr(10,10));n=parseFloat(t[g].substr(20,10));e=t[g].substr(31,3);e=e.replace(/\s+/,"");d=lookupSymbol(e);b.value+="\n   "+e+"("+d+")  "+p+", "+o+", "+n;addAtom(d,p,o,n)}f=4+s+c;for(g=4+s;g<f;g++){l=parseFloat(t[g].substr(0,3));h=parseFloat(t[g].substr(3,3));b.value+="\n   Bond from "+l+" to "+h;addBond(l,h)}}function readINPfile(p){var e,d;var o,m,l;var g,f;var b,c;var n;var h=new Array();var a=document.getElementById("qcinfo");a.value+="\n\n--- Reading Gamess input file ---\n";delMolecule();e=0;p[e].toLowerCase();while(p[e].toLowerCase().indexOf("$data")<0){e++}e++;h=p[e];h=h.replace(/\s+$/,"");a.value+="\n\nTitle: ["+h+"]\n";e++;if(p[e].toLowerCase().indexOf("c1")<0){e++}e++;while(p[e].toLowerCase().indexOf("$end")<0){a.value+="   Line = ["+p[e]+"]\n";current=p[e].replace(/\s+/g," ").replace(/^\s+/,"").split(" ");b=parseInt(current[1]);o=parseFloat(current[2]);m=parseFloat(current[3]);l=parseFloat(current[4]);addAtom(b,o,m,l);e++}for(e=1;e<molecule[0].numatoms;e++){ra=element[molecule[e].atomicnumber].radius;for(d=e+1;d<=molecule[0].numatoms;d++){rb=element[molecule[e].atomicnumber].radius;r=0.9*distance(molecule,e,d);if(r<=(ra+rb)){addBond(e,d)}}}a.value+="Finished reading input file.\n";return}function lookupSymbol(b){var a;for(a=1;a<element.length;a++){if(element[a].symbol==b){return a}}return 0}function delMolecule(){if(typeof molecule!="undefined"){molecule=null}molecule=new Array();molecule[0]=new molObject();molecule[0].numatoms=0;molecule[0].AtomScale=1;molecule[0].showlabels=0;molecule[0].showcharges=0;document.getElementById("ChargeButton").style.backgroundColor="white"}function Undo(c){var a,f;var e;var d=10;var b=document.getElementById("qcinfo");if(typeof Undo.num=="undefined"){Undo.num=0;Undo.mol=new Array();for(a=0;a<d;a++){Undo.mol[a]=new Array();Undo.mol[a][0]=0}}if(c=="pop"){f=((Undo.num+d-1)%d);Undo.num=f;b.value+=" --- Attempting to restore from slot "+f+" ---\n";if(Undo.mol[f][0]<1){alert("ERROR: No saved coordinates to restore.");return}molecule[0].numatoms=Undo.mol[f][0];for(a=1;a<=Undo.mol[f][0];a++){molecule[a].atomicnumber=Undo.mol[f][a].atomicnumber;molecule[a].x=Undo.mol[f][a].x;molecule[a].y=Undo.mol[f][a].y;molecule[a].z=Undo.mol[f][a].z;e=Undo.mol[f][a].bonds.length;for(j=0;j<e;j++){molecule[a].bonds[j]=Undo.mol[f][a].bonds[j]}}centerMolecule("molcanvas");drawMolecule("molcanvas");return}if(c=="save"){f=Undo.num;b.value+=" --- Saving geometry in slot "+f+" ---\n";Undo.mol[f]=null;Undo.mol[f]=new Array();Undo.mol[f][0]=molecule[0].numatoms;for(a=1;a<=molecule[0].numatoms;a++){Undo.mol[f][a]=new atomObject();Undo.mol[f][a].atomicnumber=molecule[a].atomicnumber;Undo.mol[f][a].x=molecule[a].x;Undo.mol[f][a].y=molecule[a].y;Undo.mol[f][a].z=molecule[a].z;Undo.mol[f][a].bonds=new Array();e=molecule[a].bonds.length;for(j=0;j<e;j++){Undo.mol[f][a].bonds[j]=molecule[a].bonds[j]}}Undo.num=((Undo.num+1)%d)}}function addAtom(g,a,f,d){var b,e=8;molecule[0].numatoms++;molecule[0].showcharges=0;document.getElementById("ChargeButton").style.backgroundColor="white";var c=molecule[0].numatoms;molecule[c]=new atomObject();molecule[c].atomicnumber=g;molecule[c].x=a;molecule[c].y=f;molecule[c].z=d;molecule[c].bonds=new Array(e);for(b=0;b<e;b++){molecule[c].bonds[b]=0}}function addBond(b,a){var c,d;d=molecule[b].bonds.length;for(c=0;c<d;c++){if(molecule[b].bonds[c]==a){c=d}if(c<d){if(molecule[b].bonds[c]==0){molecule[b].bonds[c]=a;c=d}}}d=molecule[a].bonds.length;for(c=0;c<d;c++){if(molecule[a].bonds[c]==b){c=d}if(c<d){if(molecule[a].bonds[c]==0){molecule[a].bonds[c]=b;c=d}}}}function delAtom(n){var l,g,c,f=0;var p,d;var h,e,m,b,a;var o=new Array();molecule[0].showcharges=0;document.getElementById("ChargeButton").style.backgroundColor="white";h=n;e=molecule[n].bonds.length;for(l=0;l<e;l++){g=molecule[n].bonds[l];if(molecule[g].atomicnumber==1){o[f++]=g;if(g<n){h--}}}o.sort(function(s,q){return(q-s)});for(l=0;l<f;l++){delAtom(o[l])}n=h;for(l=0;l<e;l++){p=molecule[n].bonds[l];if(p>0){m=molecule[p].bonds.length;for(g=0;g<m;g++){bondshift=0;if(molecule[p].bonds[g]==n){for(c=g+1;c<m;c++){molecule[p].bonds[c-1]=molecule[p].bonds[c]}molecule[p].bonds[m-1]=0}}}}for(l=1;l<=n;l++){b=molecule[l].bonds.length;for(d=0;d<b;d++){c=molecule[l].bonds[d];if(c>n){c--}molecule[l].bonds[d]=c}}for(l=n;l<molecule[0].numatoms;l++){g=l+1;molecule[l].atomicnumber=molecule[g].atomicnumber;molecule[l].x=molecule[g].x;molecule[l].y=molecule[g].y;molecule[l].z=molecule[g].z;a=molecule[g].bonds.length;for(d=0;d<a;d++){c=molecule[g].bonds[d];if(c>n){c--}molecule[l].bonds[d]=c}}molecule[0].numatoms--;drawMolecule("molcanvas")}function delBond(b,a){var c,d,e;e=molecule[b].bonds.length;for(c=0;c<e;c++){if(molecule[b].bonds[c]==a){for(j=c+1;j<e;j++){molecule[b].bonds[j-1]=molecule[b].bonds[j]}molecule[b].bonds[e-1]=0;c=e}}e=molecule[a].bonds.length;for(c=0;c<e;c++){if(molecule[a].bonds[c]==b){for(j=c+1;j<e;j++){molecule[a].bonds[j-1]=molecule[a].bonds[j]}molecule[a].bonds[e-1]=0;c=e}}}function centerMolecule(n){var e,c,h;var a=0;var m,f,d;var g;var b=document.getElementById(n);var l=b.height;m=0;f=0;d=0;h=molecule[0].numatoms;for(e=1;e<=h;e++){m+=molecule[e].x;f+=molecule[e].y;d+=molecule[e].z}m/=h;f/=h;d/=h;a=0;for(e=1;e<=h;e++){c=molecule[e].atomicnumber;molecule[e].x-=m;molecule[e].y-=f;molecule[e].z-=d;g=Math.abs(molecule[e].x);g=Math.max(g,Math.abs(molecule[e].y));g=Math.max(g,Math.abs(molecule[e].z));g+=element[c].radius;a=Math.max(a,g)}molecule[0].AtomScale=0.5*l/a}function showGlobal(){var a;var b=document.getElementById("qcinfo");b.value="";b.value+="numatoms = "+molecule[0].numatoms;b.value+="\nAtomScale = "+molecule[0].AtomScale.toFixed(6);b.value+="\n";for(a=1;a<=molecule[0].numatoms;a++){A=molecule[a].atomicnumber;b.value+=a+"  "+element[A].symbol;b.value+=" ("+molecule[a].x.toFixed(4);b.value+=", "+molecule[a].y.toFixed(4);b.value+=", "+molecule[a].z.toFixed(4);b.value+=")\n"}}function showMOL(){var b,a;var d;var c=document.getElementById("qcinfo");c.value="";c.value+=molecule[0].numatoms+"\n";c.value+="Molecular coordinates generated by CH5M3D.\n";for(b=1;b<=molecule[0].numatoms;b++){c.value+=element[molecule[b].atomicnumber].symbol+"  ";c.value+=XYZpretty(molecule[b].x);c.value+=XYZpretty(molecule[b].y);c.value+=XYZpretty(molecule[b].z);c.value+="\n"}}function XYZpretty(c){var b="    ";var a=new Array();if(c>=100){a=b+" "+c.toFixed(4);return a}if(c>=10){a=b+"  "+c.toFixed(4);return a}if(c>=0){a=b+"   "+c.toFixed(4);return a}if(c>=-10){a=b+"  "+c.toFixed(4);return a}if(c>=-100){a=b+" "+c.toFixed(4);return a}a=b+c.toFixed(4);return a}function formula(){var f,d,a;var h,c;var e=new Array();var g=document.getElementById("qcinfo");if(molecule[0].numatoms<1){return}e[0]=new Array(2);e[0][0]=molecule[1].atomicnumber;e[0][1]=1;c=1;for(f=2;f<=molecule[0].numatoms;f++){a=molecule[f].atomicnumber;h=0;for(d=0;d<c;d++){if(e[d][0]==a){e[d][1]=e[d][1]+1;h=1;d=c}}if(h==0){e[c]=new Array(2);e[c][0]=molecule[f].atomicnumber;e[c][1]=1;c++}}var b="<p>Formula = ";for(f=0;f<c;f++){a=e[f][0];b+=element[a].symbol;if(e[f][1]>1){b+="<sub>"+e[f][1]+"</sub>"}}b+="</p>";document.getElementById("formula").innerHTML=b}function drawMolecule(e){var u,t,s;var g,f,h;var n,z=molecule[0].numatoms;var d,m;var w,b,v,a;var p=0.5;var c=document.getElementById(e);var q=c.getContext("2d");var o=c.width;var l=c.height;clear(q,o,l);q.strokeStyle="rgb(0, 0, 255)";q.lineWidth=3;if(typeof drawMolecule.deep=="undefined"){drawMolecule.deep=[]}if(drawMolecule.deep.length!=z){t=0;drawMolecule.deep=[];for(u=drawMolecule.deep.length;u<z;u++){t++;drawMolecule.deep[u]=[];drawMolecule.deep[u]["id"]=t;drawMolecule.deep[u]["sz"]=molecule[t].z}}for(u=0;u<z;u++){t=drawMolecule.deep[u].id;drawMolecule.deep[u].z=molecule[t].z}drawMolecule.deep.sort(function(y,x){return(x.z-y.z)});for(u=0;u<z;u++){atom=drawMolecule.deep[u].id;drawAtom(q,atom,p);if(molecule[0].showcharges!=0){DrawChargeCloud(q,atom,p*1.5)}m=molecule[atom].bonds.length;for(t=0;t<m;t++){d=molecule[atom].bonds[t];if(d){for(s=u+1;s<z;s++){if(drawMolecule.deep[s].id==d){drawBond(q,atom,d,p)}}}}}}function showLabels(){if(molecule[0].showlabels==0){document.getElementById("LabelButton").style.backgroundColor="lightskyblue";molecule[0].showlabels=1;drawMolecule("molcanvas");return}document.getElementById("LabelButton").style.backgroundColor="white";molecule[0].showlabels=0;drawMolecule("molcanvas");return}function drawAtom(n,f,d){var c;var l,h,a;var m,g,e;if(typeof drawAtom.centerx=="undefined"){var b=document.getElementById("molcanvas");drawAtom.centerx=b.width/2;drawAtom.centery=b.height/2}c=molecule[f].atomicnumber;l=molecule[0].AtomScale*molecule[f].x+drawAtom.centerx;h=molecule[0].AtomScale*molecule[f].y+drawAtom.centery;a=molecule[0].AtomScale*d*element[c].radius;m=l-(0.2*a);g=h-(0.2*a);e=0.3*a;l=Math.floor(l+0.5);h=Math.floor(h+0.5);a=Math.floor(a+0.5);m=Math.floor(m+0.5);g=Math.floor(g+0.5);AtomColor=n.createRadialGradient(m,g,e,l,h,a);AtomColor.addColorStop(0,element[c].color);AtomColor.addColorStop(1,element[c].gradient);n.beginPath();n.arc(l,h,a,0,2*Math.PI,false);n.fillStyle=AtomColor;n.fill();n.lineWidth=0.01;n.strokeStyle="black";n.stroke();n.closePath();if(molecule[0].showlabels!=0){atomLabel(n,c,f,l,h)}}function DrawChargeCloud(p,g,f){var e;var m,l,a;var d,o,h,n;if(typeof drawAtom.centerx=="undefined"){var c=document.getElementById("molcanvas");drawAtom.centerx=c.width/2;drawAtom.centery=c.height/2}e=molecule[g].atomicnumber;m=molecule[0].AtomScale*molecule[g].x+drawAtom.centerx;l=molecule[0].AtomScale*molecule[g].y+drawAtom.centery;a=molecule[0].AtomScale*f*element[e].radius;var b=molecule[g].charge;if(b>=0){(b>1)?n=1:n=b;d=0;h=0;o=255}if(b<0){(b<-1)?n=1:n=-b;d=255;h=0;o=0}AtomColor="rgba("+d+","+h+","+o+","+n+")";p.beginPath();p.arc(m,l,a,0,2*Math.PI,false);p.fillStyle=AtomColor;p.fill();p.lineWidth=0.01;p.strokeStyle="black";p.stroke();p.closePath()}function atomLabel(l,b,c,a,m){var f=element[b].symbol;var d=14;var g=parseFloat(a);var e=parseFloat(m);l.lineWidth=1;l.textAlign="center";l.font="normal "+d+"px sans-serif";l.fillStyle=element[b].label;l.beginPath();l.fillText(f,g,e);var h=10/molecule[0].AtomScale;l.fillRect(g,e,h*1.5,h);l.closePath()}function drawBond(t,n,m,q){var x,v,u;var z,b,h,y,a,f;var g,e,d,p;var B,C;var p,l;var o=molecule[0].AtomScale;var s=Math.floor(0.1*o+0.5);var w="rgb(200,128,51)";if(typeof drawBond.centerx=="undefined"){var c=document.getElementById("molcanvas");drawBond.centerx=c.width/2;drawBond.centery=c.height/2}l=o*q*element[molecule[n].atomicnumber].radius;z=o*molecule[n].x+drawBond.centerx;b=o*molecule[n].y+drawBond.centery;h=o*molecule[n].z;y=o*molecule[m].x+drawBond.centerx;a=o*molecule[m].y+drawBond.centery;f=o*molecule[m].z;g=y-z;e=a-b;d=f-h;p=Math.sqrt(g*g+e*e+d*d);B=z+l*g/p;C=b+l*e/p;t.beginPath();t.moveTo(B,C);t.lineTo(y,a);t.lineWidth=s+2;t.strokeStyle="rgb(0,0,0)";t.stroke();t.moveTo(B,C);t.lineTo(y,a);t.lineWidth=s;t.strokeStyle=w;t.stroke();t.closePath()}function clear(b,c,a){b.fillStyle="rgb(255,255,255)";b.fillRect(0,0,c,a);b.beginPath();b.rect(1,1,c-1,a-1);b.lineWidth=2;b.strokeStyle="rgb(95,95,127)";b.stroke();b.closePath()}function drawHighlight(e,g,q){var v,u,t;var h,f,l;var o;var n,d;var z,b,w,a;var c=document.getElementById(e);var s=c.getContext("2d");var p=c.width;var m=c.height;clear(s,p,m);s.strokeStyle="rgb(0, 0, 255)";s.lineWidth=3;if(typeof drawHighlight.deep=="undefined"){drawHighlight.deep=[]}if(drawHighlight.deep.length!=molecule[0].numatoms){u=0;drawHighlight.deep=[];for(v=drawHighlight.deep.length;v<molecule[0].numatoms;v++){u++;drawHighlight.deep[v]=[];drawHighlight.deep[v]["id"]=u;drawHighlight.deep[v]["sz"]=molecule[u].z}}for(v=0;v<molecule[0].numatoms;v++){u=drawHighlight.deep[v].id;drawHighlight.deep[v].z=molecule[u].z}drawHighlight.deep.sort(function(y,x){return(x.z-y.z)});for(v=0;v<molecule[0].numatoms;v++){atom=drawHighlight.deep[v].id;hilite=0;for(ih=1;ih<=g[0]*3;ih++){if(atom==g[ih]){hilite=1}}HighlightAtom(s,atom,hilite,q);n=molecule[atom].bonds.length;for(u=0;u<n;u++){d=molecule[atom].bonds[u];if(d){highbond=0;if(hilite>0){for(ih=1;ih<g[0]*3;ih++){if(d==g[ih]){highbond=1}}}for(t=v+1;t<molecule[0].numatoms;t++){if(drawHighlight.deep[t].id==d){HighlightBond(s,atom,d,highbond,q)}}}}}}function HighlightAtom(s,g,a,p){var o;var l,h,n;var t,w,u;var b,v,d;var f=new Array();var q="rgb(191,191,191)";var m="rgb(255,  0,  0)";var e="rgb(127,  0,  0)";if(typeof drawAtom.centerx=="undefined"){var c=document.getElementById("molcanvas");drawAtom.centerx=c.width/2;drawAtom.centery=c.height/2}o=molecule[g].atomicnumber;l=molecule[0].AtomScale*molecule[g].x+drawAtom.centerx;h=molecule[0].AtomScale*molecule[g].y+drawAtom.centery;n=molecule[0].AtomScale*p*element[o].radius;t=l-(0.2*n);w=h-(0.2*n);u=0.3*n;l=Math.floor(l+0.5);h=Math.floor(h+0.5);n=Math.floor(n+0.5);t=Math.floor(t+0.5);w=Math.floor(w+0.5);AtomColor=s.createRadialGradient(t,w,u,l,h,n);alpha=0.33;if(a>0){alpha=1}b=element[o].color.indexOf("(")+1;v=element[o].color.indexOf(")")-b;d=element[o].color.substr(b,v);f=d.replace(/,/g," ").split(" ");m="rgba("+f[0]+","+f[1]+","+f[2]+","+alpha+")";b=element[o].gradient.indexOf("(")+1;v=element[o].gradient.indexOf(")")-b;d=element[o].gradient.substr(b,v);f=d.replace(/,/g," ").split(" ");e="rgba("+f[0]+","+f[1]+","+f[2]+","+alpha+")";AtomColor.addColorStop(0,m);AtomColor.addColorStop(1,e);s.beginPath();s.arc(l,h,n,0,2*Math.PI,false);s.fillStyle=AtomColor;s.fill();s.lineWidth=0.01;s.strokeStyle="black";s.stroke();s.closePath();if(a>0){atomLabel(s,o,g,l,h)}}function HighlightBond(v,o,n,d,s){var z,x,w;var C,b,l,B,a,g;var h,f,e,q;var D,E;var q,m;var p=molecule[0].AtomScale;var u=Math.floor(0.1*p+0.5);var y="rgba(200,128,51,1.0)";var t="rgba(191,191,191,0.33)";if(typeof drawBond.centerx=="undefined"){var c=document.getElementById("molcanvas");drawBond.centerx=c.width/2;drawBond.centery=c.height/2}m=p*s*element[molecule[o].atomicnumber].radius;C=p*molecule[o].x+drawBond.centerx;b=p*molecule[o].y+drawBond.centery;l=p*molecule[o].z;B=p*molecule[n].x+drawBond.centerx;a=p*molecule[n].y+drawBond.centery;g=p*molecule[n].z;h=B-C;f=a-b;e=g-l;q=Math.sqrt(h*h+f*f+e*e);D=C+m*h/q;E=b+m*f/q;v.beginPath();v.moveTo(D,E);v.lineTo(B,a);v.lineWidth=u+2;v.strokeStyle="rgba(0,0,0,0.33)";if(d>0){v.strokeStyle="rgba(0,0,0,1.0)"}v.stroke();v.moveTo(D,E);v.lineTo(B,a);v.lineWidth=u;if(d>0){v.strokeStyle=y}else{v.strokeStyle=t}v.stroke();v.closePath()}function mouseState(a,b){if(typeof mouseState.DownAtom=="undefined"){mouseState.DownAtom=-1}if(a=="Show"){return mouseState.DownAtom}if(a=="Set"){mouseState.DownAtom=b}}function param(a,b){if(typeof param.mode=="undefined"){param.mode="View"}if(typeof param.elem=="undefined"){param.elem="C"}if(typeof param.clouds=="undefined"){param.clouds=4}if(typeof param.add=="undefined"){param.add="Add"}if(typeof param.bond=="undefined"){param.bond="Add"}if(a=="elem"){return param.elem}if(a=="clouds"){return param.clouds}if(a=="bondMode"){return param.bond}if(a=="setElem"){param.elem=b;param.add="Add";param.bond="Add"}if(a=="setClouds"){param.clouds=b}if(a=="Delete"){param.add="Delete"}if(a=="DelBond"){param.bond="Delete"}if(a=="RotateBond"){param.bond="Rotate"}if(a=="ClearBond"){param.bond=""}}function MouseDown(c){var b,h;var f="molcanvas";var d=document.getElementById(f);var e=d.width;var a=d.height;b=c.pageX;h=c.pageY;if(c.targetTouches){if(c.targetTouches.length==1){var g=c.targetTouches[0];b=g.pageX;h=g.pageY}}mouseState("Set",onAtom(b,h,d,e,a))}function MouseUp(h){var e,c;var g,d;var m="molcanvas";var b=document.getElementById(m);var a=b.width;var l=b.height;e=h.pageX;c=h.pageY;if(h.targetTouches){var f=h.targetTouches[0];e=f.pageX;c=f.pageY}g=mouseState("Show");mouseState("Set",-1);Upatom=onAtom(e,c,b,a,l);if(Upatom==0){viewGeom(0);return}if(Upatom==g){if(param.mode=="View"){viewGeom(g)}if(param.mode=="Draw"){Undo("save");if(param.add=="Delete"){delAtom(Upatom)}else{newAtom(Upatom)}}}if((Upatom!=g)&&(param.mode=="Draw")){Undo("save");if(param.bond=="Add"){addBond(g,Upatom)}if(param.bond=="Delete"){delBond(g,Upatom)}if(param.bond=="Rotate"){BondRotation("Set",g,Upatom)}drawMolecule("molcanvas")}}function onAtom(l,g,b,a,m){var e,c,o,n;var f,h;var d=0.5;l=(l-b.offsetLeft-a/2);g=(g-b.offsetTop-m/2);for(e=1;e<=molecule[0].numatoms;e++){c=molecule[e].atomicnumber;f=molecule[0].AtomScale*d*element[c].radius;f=f*f;o=molecule[0].AtomScale*molecule[e].x-l;n=molecule[0].AtomScale*molecule[e].y-g;h=o*o+n*n;if(h<=f){return e}}return 0}function MouseWheel(a){if(a.preventDefault){a.preventDefault()}var c=a.detail?a.detail*(-1):a.wheelDelta;var b=(c>0)?1.1:0.9;molecule[0].AtomScale=molecule[0].AtomScale*b;drawMolecule("molcanvas");return false}function MouseMove(q){var e,d;var p,o,w;var n,m,l;var t,a;var u,s,c,b;var v,f;var g=2;if(typeof MouseMove.cx=="undefined"){MouseMove.cx=250}if(typeof MouseMove.cy=="undefined"){MouseMove.cy=250}if(mouseState("Show")==0){e=q.pageX;d=q.pageY;if(q.targetTouches){if(q.targetTouches.length==1){var h=q.targetTouches[0];e=h.pageX;d=h.pageY}}p=(MouseMove.cx-e);o=(MouseMove.cy-d);MouseMove.cx=e;MouseMove.cy=d;if(Math.abs(p)+Math.abs(o)>10){return}if(param("bondMode")=="Rotate"){w=p+o;BondRotation("Rotate",w);drawMolecule("molcanvas");return}u=Math.cos(o*g*Math.PI/180);c=Math.sin(o*g*Math.PI/180);s=Math.cos(p*g*Math.PI/180);b=Math.sin(p*g*Math.PI/180);for(i=1;i<=molecule[0].numatoms;i++){n=molecule[i].x;m=molecule[i].y;l=molecule[i].z;molecule[i].x=s*n+b*l;molecule[i].y=-c*b*n+u*m+c*s*l;molecule[i].z=-u*b*n-c*m+u*s*l}drawMolecule("molcanvas")}}function viewGeom(x){var y,e,c,b,a;var m,l,h,z;var u,s,p,D,C,B,q,n;var g;var o="molcanvas";var f=document.getElementById(o);var w=f.getContext("2d");var v=f.width;var t=f.height;if(typeof viewGeom.geom=="undefined"){viewGeom.geom=[0,0,0,0,0]}if(x==0){for(y=0;y<5;y++){viewGeom.geom[y]=0}drawMolecule(o);return}if(x){for(y=1;y<5;y++){if(viewGeom.geom[y]==x){viewGeom(0)}}}viewGeom.geom[0]=viewGeom.geom[0]+1;sw=viewGeom.geom[0];viewGeom.geom[sw]=x;switch(sw){case 1:e=molecule[viewGeom.geom[1]].atomicnumber;g=element[e].symbol+viewGeom.geom[1].toString();if(molecule[0].showcharges!=0){g+=": Charge = ";if(molecule[viewGeom.geom[1]].charge>0){g+="+"}g+=molecule[viewGeom.geom[1]].charge.toFixed(2)}drawMolecule(o);geomLabel(w,g,v);break;case 2:m=molecule[viewGeom.geom[1]].x-molecule[viewGeom.geom[2]].x;l=molecule[viewGeom.geom[1]].y-molecule[viewGeom.geom[2]].y;h=molecule[viewGeom.geom[1]].z-molecule[viewGeom.geom[2]].z;z=Math.sqrt(m*m+l*l+h*h);z=z.toFixed(3);z=z.toString();e=molecule[viewGeom.geom[1]].atomicnumber;c=molecule[viewGeom.geom[2]].atomicnumber;g=element[e].symbol+viewGeom.geom[1].toString()+"--";g+=element[c].symbol+viewGeom.geom[2].toString();g+=" = "+z;drawMolecule(o);geomLabel(w,g,v);break;case 3:e=molecule[viewGeom.geom[1]].atomicnumber;c=molecule[viewGeom.geom[2]].atomicnumber;b=molecule[viewGeom.geom[3]].atomicnumber;g=element[e].symbol+viewGeom.geom[1].toString()+"--";g+=element[c].symbol+viewGeom.geom[2].toString()+"--";g+=element[b].symbol+viewGeom.geom[3].toString();ang=angle(molecule,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3]);ang=ang.toFixed(1);ang=ang.toString();g+=" = "+ang+"ᵒ";drawMolecule(o);geomLabel(w,g,v);break;case 4:e=molecule[viewGeom.geom[1]].atomicnumber;c=molecule[viewGeom.geom[2]].atomicnumber;b=molecule[viewGeom.geom[3]].atomicnumber;a=molecule[viewGeom.geom[4]].atomicnumber;g=element[e].symbol+viewGeom.geom[1].toString()+"--";g+=element[c].symbol+viewGeom.geom[2].toString()+"--";g+=element[b].symbol+viewGeom.geom[3].toString()+"--";g+=element[a].symbol+viewGeom.geom[4].toString();ang=dihedral(molecule,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3],viewGeom.geom[4]);ang=ang.toFixed(1);ang=ang.toString();g+=" = "+ang;drawMolecule(o);geomLabel(w,g,v);for(y=0;y<5;y++){viewGeom.geom[y]=0}break}}function geomLabel(a,b,c){a.lineWidth=1;a.textAlign="right";a.textBaseline="top";a.font="normal 18px sans-serif";a.fillStyle="#000000";a.beginPath();a.fillText(b,c-5,5);a.closePath()}function pickElem(c){var b=element.length;var a,h,e;var g;var d="silver";var f="lightskyblue";if(typeof pickElem.metals=="undefined"){pickElem.metals="none";pickElem.myfont="14px"}if(c=="MOff"){pickElem.metals="none";pickElem.myfont="14px";document.getElementById("MOn").style.color="navy";document.getElementById("MOff").style.color="LemonChiffon"}if(c=="MOn"){pickElem.metals="table-cell";pickElem.myfont="10px";document.getElementById("MOn").style.color="LemonChiffon";document.getElementById("MOff").style.color="navy"}document.getElementById("Row1").style.display=pickElem.metals;document.getElementById("Row2").style.display=pickElem.metals;document.getElementById("Row3").style.display=pickElem.metals;document.getElementById("RowLa").style.display=pickElem.metals;document.getElementById("RowAc").style.display=pickElem.metals;document.getElementById("RowLa2").style.display=pickElem.metals;document.getElementById("RowAc2").style.display=pickElem.metals;document.getElementById("MOn").style.fontSize=pickElem.myfont;document.getElementById("MOff").style.fontSize=pickElem.myfont;for(a=1;a<b;a++){h="m"+element[a].symbol;if(document.getElementById(h)){e=document.getElementById(h).style}h="p"+element[a].symbol;if(document.getElementById(h)){e=document.getElementById(h).style;e.display=pickElem.metals}e.backgroundColor=d;e.fontSize=pickElem.myfont;if(element[a].symbol==c){e.backgroundColor=f}}document.getElementById("delbtn").style.backgroundColor=d;document.getElementById("delbond").style.backgroundColor=d;document.getElementById("rotbond").style.backgroundColor=d;if(c=="Delete"){document.getElementById("delbtn").style.backgroundColor=f;param("Delete");return}if(c=="DelBond"){document.getElementById("delbond").style.backgroundColor=f;param("DelBond");return}if(c=="RotateBond"){g=param("bondMode");if(param("bondMode")!="Rotate"){document.getElementById("rotbond").style.backgroundColor=f;param("RotateBond")}else{param("ClearBond");BondRotation("Clear")}return}param("setElem",c)}function pickClouds(b){var a,c;var d=parseInt(b);for(a=1;a<5;a++){c="cld"+a;document.getElementById(c).style.backgroundColor="silver";if(a==d){document.getElementById(c).style.backgroundColor="lightskyblue"}}param("setClouds",d)}function drawmode(){document.getElementById("drawDiv").style.display="inline";document.getElementById("viewDiv").style.display="none";document.getElementById("modeDraw").style.backgroundColor="lightskyblue";document.getElementById("modeView").style.backgroundColor="silver";param.mode="Draw"}function viewmode(){document.getElementById("drawDiv").style.display="none";document.getElementById("viewDiv").style.display="inline";document.getElementById("modeDraw").style.backgroundColor="silver";document.getElementById("modeView").style.backgroundColor="lightskyblue";param.mode="View";pickElem("ClearBond");formula()}function BondRotation(d,m,f){var b,h;var n,l,o,e;var c,g;var a=1;if(typeof BondRotation.RotateAtom1=="undefined"){BondRotation.RotateAtom1=0}if(typeof BondRotation.RotateAtom2=="undefined"){BondRotation.RotateAtom2=0}if(typeof BondRotation.RotateList=="undefined"){BondRotation.RotateList=new Array();BondRotation.RotateList[0]=0}if(d=="Clear"){BondRotation.RotateAtom1=0;BondRotation.RotateAtom2=0;BondRotation.RotateList[0]=0;return}if(d=="Set"){BondRotation.RotateAtom1=m;BondRotation.RotateAtom2=f;bondAlign(m,f);return}if(d=="Rotate"){atom1=BondRotation.RotateAtom1;atom2=BondRotation.RotateAtom2;c=Math.cos(m*a*Math.PI/360);g=Math.sin(m*a*Math.PI/360);if(BondRotation.RotateList[0]==0){BondRotation.RotateList[0]=1;BondRotation.RotateList[1]=BondRotation.RotateAtom2;BondRotation.RotateList=rotlist(BondRotation.RotateList,atom1,atom2)}o=molecule[atom1].x;e=molecule[atom1].y;for(h=1;h<=BondRotation.RotateList[0];h++){b=BondRotation.RotateList[h];n=molecule[b].x-o;l=molecule[b].y-e;molecule[b].x=c*n+g*l+o;molecule[b].y=-g*n+c*l+e}}}function bondAlign(c,a){var e;var h,g,f;var p,o,m;var n,l,d,b;p=molecule[a].x-molecule[c].x;o=molecule[a].y-molecule[c].y;m=molecule[a].z-molecule[c].z;if((o==0)&&(m==0)){n=1;d=0}else{n=Math.sqrt(m*m/((o*o)+(m*m)));d=Math.sqrt(1-(n*n))}vsign=o*m;if(vsign<0){d=-d}f=d*o+n*m;if((p==0)&&(f==0)){l=1;b=0}else{l=Math.sqrt(f*f/((p*p)+(f*f)));b=Math.sqrt(1-(l*l))}vsign=p*f;if(vsign<0){b=-b}for(e=1;e<=molecule[0].numatoms;e++){h=molecule[e].x;g=molecule[e].y;f=molecule[e].z;molecule[e].x=(h*l)-(g*d*b)-(f*n*b);molecule[e].y=(g*n)-(f*d);molecule[e].z=(h*b)+(g*d*l)+(f*n*l)}if(molecule[c].z<molecule[a].z){for(e=1;e<=molecule[0].numatoms;e++){molecule[e].x=-molecule[e].x;molecule[e].z=-molecule[e].z}}}function rotlist(b,c,a){var e,d;var h,g;var f=document.getElementById("qcinfo");maxBonds=molecule[a].bonds.length;for(e=0;e<maxBonds;e++){h=molecule[a].bonds[e];if(h>0){g=0;if(h==c){g=1}for(d=1;d<=b[0];d++){if(h==b[d]){g=1;d=b[0]+1}}if(g==0){b[0]++;b[b[0]]=h;rotlist(b,a,h)}}}return b}function newAtom(g){var e,d,c,o;var n,m,h,f;var l,a;var b;b=param("elem");atomicNumber=lookupSymbol(b);g;o=0;maxBonds=molecule[g].bonds.length;for(e=0;e<maxBonds;e++){if(molecule[g].bonds[e]>0){o++}}if(o==0){a=element[atomicNumber].radius+element[molecule[g].atomicnumber].radius;dx=molecule[g].x+a;dy=molecule[g].y;dz=molecule[g].z;addAtom(atomicNumber,dx,dy,dz);addBond(g,molecule[0].numatoms);addH(molecule[0].numatoms);centerMolecule("molcanvas");drawMolecule("molcanvas")}if(atomicNumber==1){n=0;m=0;h=0;for(e=0;e<o;e++){d=molecule[g].bonds[e];dx=molecule[d].x-molecule[g].x;dy=molecule[d].y-molecule[g].y;dz=molecule[d].z-molecule[g].z;dd=Math.sqrt(dx*dx+dy*dy+dz*dz);n+=dx/dd;m+=dy/dd;h+=dz/dd}f=Math.sqrt(n*n+m*m+h*h);if((f<0.1)&&(o>1)){e=molecule[g].bonds[0];d=molecule[g].bonds[1];n=(molecule[e].y-molecule[g].y)*(molecule[d].z-molecule[g].z);n-=(molecule[e].z-molecule[g].z)*(molecule[d].y-molecule[g].y);m=(molecule[e].z-molecule[g].z)*(molecule[d].x-molecule[g].x);m-=(molecule[e].x-molecule[g].x)*(molecule[d].z-molecule[g].z);h=(molecule[e].x-molecule[g].x)*(molecule[d].y-molecule[g].y);h-=(molecule[e].y-molecule[g].y)*(molecule[d].x-molecule[g].x);f=Math.sqrt(n*n+m*m+h*h)}a=element[1].radius+element[molecule[g].atomicnumber].radius;n=molecule[g].x-n*a/f;m=molecule[g].y-m*a/f;h=molecule[g].z-h*a/f;addAtom(1,n,m,h);addBond(g,molecule[0].numatoms);centerMolecule("molcanvas");drawMolecule("molcanvas");o=0}if(o==1){e=g;d=molecule[g].bonds[0];dx=molecule[e].x-molecule[d].x;dy=molecule[e].y-molecule[d].y;dz=molecule[e].z-molecule[d].z;l=Math.sqrt(dx*dx+dy*dy+dz*dz);a=element[atomicNumber].radius+element[molecule[d].atomicnumber].radius;dx*=a/l;dy*=a/l;dz*=a/l;molecule[e].atomicnumber=atomicNumber;molecule[e].x=dx+molecule[d].x;molecule[e].y=dy+molecule[d].y;molecule[e].z=dz+molecule[d].z;addH(g);centerMolecule("molcanvas");drawMolecule("molcanvas")}if(o>1){molecule[g].atomicnumber=atomicNumber;drawMolecule("molcanvas")}}function addH(c){var b,a,g,e,d;var f;b=molecule[c].bonds[0];if(b==0){for(a=1;a<molecule[0].numatoms;a++){if(a!=c){b=a;a=molecule[0].numatoms}}}if(b>0){a=molecule[b].bonds[0]}if((a==c)&&(b>0)){a=molecule[b].bonds[1]}if((c==b)||(c==a)){if((b==a)&&(b>0)){f="";f+="ERROR Adding H: H";f+="--"+element[molecule[c].atomicnumber].symbol+c;f+="--"+element[molecule[b].atomicnumber].symbol+b;f+="--"+element[molecule[a].atomicnumber].symbol+a;alert(f)}}g=param("clouds");e=molecule[c].atomicnumber;valence=element[e].valence;d=3+g-valence;if(e<=2){d=0}if(d<1){g=1}switch(g){case 1:break;case 2:add1H(c,b);break;case 3:add2H(c,b,a,d);break;case 4:add3H(c,b,a,d);break}centerMolecule("molcanvas");drawMolecule("molcanvas")}function add1H(f,c){var b,o,n,m;var d,e,a;var l,h,g;d=molecule[f].atomicnumber;a=element[d].radius+element[1].radius;if(c==0){o=molecule[f].x+a;n=molecule[f].y;m=molecule[f].z;addAtom(1,l,h,g);addBond(f,molecule[0].numatoms);return}o=molecule[c].x-molecule[f].x;n=molecule[c].y-molecule[f].y;m=molecule[c].z-molecule[f].z;e=Math.sqrt(o*o+n*n+m*m);l=molecule[f].x-o*a/e;h=molecule[f].y-n*a/e;g=molecule[f].z-m*a/e;addAtom(1,l,h,g);addBond(f,molecule[0].numatoms)}function add2H(a,E,D,B){var z,t,q,F;var u,s,p,d;var f,e,c,G,I;var y,x,w,o;var L,J,H,m,l,g;var N,M,K,b;var h;var n=new Array();z=molecule[a].atomicnumber;F=element[z].radius+element[1].radius;if(E==0){L=molecule[a].x+0.5*F;J=molecule[a].y+F*Math.sqrt(3)/2;H=molecule[a].z;addAtom(1,L,J,H);addBond(a,molecule[0].numatoms);if(B>1){J=molecule[a].y-F*Math.sqrt(3)/2;addAtom(1,L,J,H);addBond(a,molecule[0].numatoms)}return}t=molecule[E].atomicnumber;u=molecule[E].x-molecule[a].x;s=molecule[E].y-molecule[a].y;p=molecule[E].z-molecule[a].z;d=Math.sqrt(u*u+s*s+p*p);if(D==0){for(var v=1;v<molecule[0].numatoms;v++){if((v!=a)&&(v!=E)){D=v;v=molecule[0].numatoms}}}if(D==0){molecule[a].x=0;molecule[a].y=0;molecule[a].z=0;molecule[E].x=-d;molecule[E].y=0;molecule[E].z=0;L=molecule[a].x+0.5*F;J=molecule[a].y+F*Math.sqrt(3)/2;H=molecule[a].z;addAtom(1,L,J,H);addBond(a,molecule[0].numatoms);if(B>1){J=molecule[a].y-F*Math.sqrt(3)/2;addAtom(1,L,J,H);addBond(a,molecule[0].numatoms)}return}q=molecule[D].atomicnumber;f=molecule[D].x-molecule[E].x;e=molecule[D].y-molecule[E].y;c=molecule[D].z-molecule[E].z;G=Math.sqrt(f*f+e*e+c*c);n[0]=u;n[1]=s;n[2]=p;n[3]=-F*d/2;I=(-u*f-s*e-p*c)/(d*G);I=Math.acos(-1/2)+Math.PI-Math.acos(I);n[4]=f;n[5]=e;n[6]=c;n[7]=F*G*Math.cos(I);y=c*s-e*p;x=f*p-c*u;w=e*u-f*s;o=Math.sqrt(y*y+x*x+w*w);n[8]=y;n[9]=x;n[10]=w;n[11]=0;var C=gaussElim(n);L=molecule[a].x+C[0];J=molecule[a].y+C[1];H=molecule[a].z+C[2];addAtom(1,L,J,H);addBond(a,molecule[0].numatoms);if(B==1){return}n[0]=u;n[1]=s;n[2]=p;n[3]=-F*d/2;I=(-u*f-s*e-p*c)/(d*G);I=Math.acos(I)-Math.acos(0.5);n[4]=f;n[5]=e;n[6]=c;n[7]=F*G*Math.cos(I);n[8]=y;n[9]=x;n[10]=w;n[11]=0;debug="\nRow 1: "+n[0].toFixed(4)+" "+n[1].toFixed(4);debug+=" "+n[2].toFixed(4)+" "+n[3].toFixed(4);debug+="\nRow 2: "+n[4].toFixed(4)+" "+n[5].toFixed(4);debug+=" "+n[6].toFixed(4)+" "+n[7].toFixed(4);debug+="\nRow 3: "+n[8].toFixed(4)+" "+n[9].toFixed(4);debug+=" "+n[10].toFixed(4)+" "+n[11].toFixed(4);C=gaussElim(n);L=molecule[a].x+C[0];J=molecule[a].y+C[1];H=molecule[a].z+C[2];debug="H2 at: ("+L.toFixed(4)+", "+J.toFixed(4)+", "+H.toFixed(4)+")";addAtom(1,L,J,H);addBond(a,molecule[0].numatoms);debug="atom = "+a+"  i = "+E+"  numatoms = "+molecule[0].numatoms;debug+="\n"+element[molecule[molecule[0].numatoms].atomicnumber].symbol;debug+="\nRow 1: "+n[0].toFixed(4)+" "+n[1].toFixed(4);debug+=" "+n[2].toFixed(4)+" "+n[3].toFixed(4);debug+="\nRow 2: "+n[4].toFixed(4)+" "+n[5].toFixed(4);debug+=" "+n[6].toFixed(4)+" "+n[7].toFixed(4);debug+="\nRow 3: "+n[8].toFixed(4)+" "+n[9].toFixed(4);debug+=" "+n[10].toFixed(4)+" "+n[11].toFixed(4);debug+="\nCross: "+y.toFixed(4)+" "+x.toFixed(4)+" "+w.toFixed(4)}function add3H(a,D,C,z){var y,t,q,E;var u,s,p,d;var f,e,c,F,H;var x,w,v,o;var K,I,G,m,l,g;var M,L,J,b;var h;var n=new Array();y=molecule[a].atomicnumber;t=molecule[D].atomicnumber;q=molecule[C].atomicnumber;E=element[y].radius+element[1].radius;u=molecule[D].x-molecule[a].x;s=molecule[D].y-molecule[a].y;p=molecule[D].z-molecule[a].z;d=Math.sqrt(u*u+s*s+p*p);n[0]=u;n[1]=s;n[2]=p;n[3]=-E*d/3;f=molecule[C].x-molecule[D].x;e=molecule[C].y-molecule[D].y;c=molecule[C].z-molecule[D].z;F=Math.sqrt(f*f+e*e+c*c);H=(-u*f-s*e-p*c)/(d*F);H=Math.acos(-1/3)+Math.PI-Math.acos(H);n[4]=f;n[5]=e;n[6]=c;n[7]=E*F*Math.cos(H);x=c*s-e*p;w=f*p-c*u;v=e*u-f*s;o=Math.sqrt(x*x+w*w+v*v);if(o==0){x=molecule[a].y;w=-molecule[a].x;v=molecule[a].z;o=Math.sqrt(x*x+w*w+v*v)}n[8]=x;n[9]=w;n[10]=v;n[11]=0;var B=gaussElim(n);K=molecule[a].x+B[0];I=molecule[a].y+B[1];G=molecule[a].z+B[2];addAtom(1,K,I,G);addBond(a,molecule[0].numatoms);if(z==1){return}h=molecule[0].numatoms;b=E/(d*3);M=molecule[a].x-u*b;L=molecule[a].y-s*b;J=molecule[a].z-p*b;n[0]=molecule[h].x-M;n[1]=molecule[h].y-L;n[2]=molecule[h].z-J;n[3]=-E*E*4/9;m=B[0];l=B[1];g=B[2];n[4]=molecule[a].x-M;n[5]=molecule[a].y-L;n[6]=molecule[a].z-J;n[7]=0;n[8]=x;n[9]=w;n[10]=v;n[11]=E*o*Math.sqrt(2/3);var B=gaussElim(n);K=M+B[0];I=L+B[1];G=J+B[2];addAtom(1,K,I,G);addBond(a,molecule[0].numatoms);if(z==2){return}n[0]=molecule[h].x-M;n[1]=molecule[h].y-L;n[2]=molecule[h].z-J;n[3]=-E*E*4/9;m=B[0];l=B[1];g=B[2];n[4]=molecule[a].x-M;n[5]=molecule[a].y-L;n[6]=molecule[a].z-J;n[7]=0;o=Math.sqrt(x*x+w*w+v*v);n[8]=x;n[9]=w;n[10]=v;n[11]=-E*o*Math.sqrt(2/3);debug="atom = "+a+"  i = "+D+"  numatoms = "+molecule[0].numatoms;debug+="\n"+element[molecule[molecule[0].numatoms].atomicnumber].symbol;debug+="\nRow 1: "+n[0].toFixed(4)+" "+n[1].toFixed(4);debug+=" "+n[2].toFixed(4)+" "+n[3].toFixed(4);debug+="\nRow 2: "+n[4].toFixed(4)+" "+n[5].toFixed(4);debug+=" "+n[6].toFixed(4)+" "+n[7].toFixed(4);debug+="\nRow 3: "+n[8].toFixed(4)+" "+n[9].toFixed(4);debug+=" "+n[10].toFixed(4)+" "+n[11].toFixed(4);debug+="\nCross: "+x.toFixed(4)+" "+w.toFixed(4)+" "+v.toFixed(4);var B=gaussElim(n);K=M+B[0];I=L+B[1];G=J+B[2];addAtom(1,K,I,G);addBond(a,molecule[0].numatoms)}function gaussElim(f){var n,l,g,v;var q=new Array();var o=parseFloat(f[0]);var m=parseFloat(f[1]);var h=parseFloat(f[2]);var w=parseFloat(f[3]);var u=parseFloat(f[4]);var t=parseFloat(f[5]);var s=parseFloat(f[6]);var e=parseFloat(f[7]);var d=parseFloat(f[8]);var b=parseFloat(f[9]);var a=parseFloat(f[10]);var p=parseFloat(f[11]);if((Math.abs(u)>Math.abs(o))&&(Math.abs(u)>Math.abs(d))){n=o;l=m;g=h;v=w;o=u;m=t;h=s;w=e;u=n;t=l;s=g;e=v}if((Math.abs(d)>Math.abs(o))&&(Math.abs(d)>Math.abs(u))){n=o;l=m;g=h;v=w;o=d;m=b;h=a;w=p;d=n;b=l;a=g;p=v}if(Math.abs(d)>Math.abs(u)){n=u;l=t;g=s;v=e;u=d;t=b;s=a;e=p;d=n;b=l;a=g;p=v}if((o!=0)&&(u!=0)){factor=-o/u;u=0;t=t*factor+m;s=s*factor+h;e=e*factor+w}if((o!=0)&&(d!=0)){factor=-o/d;d=0;b=b*factor+m;a=a*factor+h;p=p*factor+w}if(Math.abs(b)>Math.abs(t)){l=t;g=s;v=e;t=b;s=a;e=p;b=l;a=g;p=v}if((t!=0)&&(b!=0)){factor=-t/b;b=0;a=a*factor+s;p=p*factor+e}q[2]=0;if(a!=0){q[2]=p/a}q[1]=0;if(t!=0){q[1]=(e-(s*q[2]))/t}q[0]=0;if(o!=0){q[0]=(w-(h*q[2])-(m*q[1]))/o}return q}function peptideInfo(){var b,e;var a=0.5;var d=new Array();var c=document.getElementById("qcinfo");c.value="Information about Amino Acid/Peptide Structure\n";d=backbone();e=d[0]*3;if(e<1){c.value+="\nThis compound does not appear to an amino acid/peptide.\n";return}c.value+="\nFinal Ordered sequence contains "+d[0]+" amino acids.\n";for(b=1;b<=e;b++){c.value+=d[b];if(b<e){c.value+=" - "}}c.value+="\n";if(e>1){DorL(d);backangles(d);drawHighlight("molcanvas",d,a)}}function backbone(){var p,o,g;var h,e,l,s;var n,d,t;var u,c,q;var a=new Array();var m=new Array();var f=new Array();var b=document.getElementById("qcinfo");c=0;for(p=1;p<=molecule[0].numatoms;p++){q=-1;if(molecule[p].atomicnumber==6){n=molecule[p].bonds.length;for(h=0;h<n;h++){o=molecule[p].bonds[h];if(molecule[o].atomicnumber==7){for(e=0;e<n;e++){g=molecule[p].bonds[e];if(molecule[g].atomicnumber==6){d=molecule[g].bonds.length;for(bk=0;bk<d;bk++){kN=molecule[g].bonds[bk];if(molecule[kN].atomicnumber==7){q=kN}}for(bk=0;bk<d;bk++){l=molecule[g].bonds[bk];if(molecule[l].atomicnumber==8){u=0;t=molecule[g].bonds.length;for(s=0;s<t;s++){if(molecule[l].bonds[s]>0){u++}}if(u==1){unique=1;for(na=0;na<c;na++){if(a[na][0]==o){unique=0}}if(unique>0){a[c]=new Array();a[c][0]=o;a[c][1]=p;a[c][2]=g;a[c][3]=q;c++}}}}}}}}}}f[0]=0;if(c==0){return f}lookfor=-1;pos=c;found=1;while(found>0){found=0;for(p=0;p<c;p++){if(a[p][3]==lookfor){found=1;pos--;m[pos]=p;lookfor=a[p][0];p=c}}}pos=1;f[0]=c;for(p=0;p<c;p++){o=m[p];f[pos++]=a[o][0];f[pos++]=a[o][1];f[pos++]=a[o][2]}return f}function DorL(h){var x,w,v;var f,I,b,o,g;var n,m,l;var F,E,C;var d,c,a;var q,t,s,p;var e,D,B,z;var u,G;var H;var y=document.getElementById("qcinfo");H=h[0];if(H<1){return}y.value+="\nDetermining the configuration of "+H+" amino acid(s).\n";for(x=0;x<H;x++){f=0;I=0;b=h[x*3+1];o=h[x*3+2];g=h[x*3+3];u=molecule[o].bonds.length;for(w=0;w<u;w++){v=molecule[o].bonds[w];if(molecule[v].atomicnumber==1){f=v}if((v!=g)&&(molecule[v].atomicnumber==6)){I=v}}if((f>0)&&(I>0)){n=(molecule[g].x+molecule[b].x+molecule[I].x)/3;m=(molecule[g].y+molecule[b].y+molecule[I].y)/3;l=(molecule[g].z+molecule[b].z+molecule[I].z)/3;F=molecule[b].x-n;E=molecule[b].y-m;C=molecule[b].z-l;d=molecule[g].x-n;c=molecule[g].y-m;a=molecule[g].z-l;D=E*a-C*c;B=C*d-F*a;z=F*c-E*d;e=Math.sqrt(D*D+B*B+z*z);t=molecule[f].x-molecule[o].x;s=molecule[f].y-molecule[o].y;p=molecule[f].z-molecule[o].z;q=Math.sqrt(t*t+s*s+p*p);G=(D*t+B*s+z*p)/(e*q);if(G<-0.5){y.value+="     - Amino acid "+(x+1)+" is L.\n"}if(G>0.5){y.value+="     - Amino acid "+(x+1)+" is D.\n"}if(Math.abs(G)<0.5){y.value+="     - Cannot determine whether amino acid "+(x+1)+" is D or L.\n"}}}return}function backangles(a){var b,f;var e=["psi","omega","phi"];var c=["N-CA-C-N","CA-C-N-CA","C-N-CA-C"];var d=document.getElementById("qcinfo");if(a[0]<2){return}d.value+="\nShowing dihedral angles along backbone. (Omega should be ~180)\n";pos=0;iA=1;iB=2;iC=3;iD=4;f=a[0]*3;while(iD<=f){ang=dihedral(molecule,a[iA],a[iB],a[iC],a[iD]);d.value+="   Angle "+e[pos%3]+" ("+c[pos%3]+") = "+ang.toFixed(3)+" degrees.\n";pos++;iA++;iB++;iC++;iD++}}function simpleQ(){var d,c;var e=molecule[0].numatoms;var a=new Array();var b=document.getElementById("bondMatrix");b.innerHTML="";if(molecule[0].showcharges!=0){document.getElementById("ChargeButton").style.backgroundColor="white";molecule[0].showcharges=0;drawMolecule("molcanvas");return}document.getElementById("ChargeButton").style.backgroundColor="lightskyblue";molecule[0].showcharges=1;for(d=0;d<=e;d++){a[d]=new Array();for(c=0;c<=e;c++){a[d][c]=0}}sigmaBonds(a,e);checkOctet(a,e);limitShare(a,e);formPi(a,e);checkOctet(a,e);limitShare(a,e);formPi(a,e);checkOctet(a,e);dative=0;for(d=1;d<=e;d++){if(a[0][d]>0){dative=1}}if(dative>0){formDative(a,e)}checkOctet(a,e);for(d=1;d<=e;d++){if(a[0][d]>0){b.innerHTML+="<p>Atom "+d+" violates octet rule: Missing "+a[0][d]+" electrons.</p>"}}atomicCharge(a,e);showBondMatrix(a,b,e);drawMolecule("molcanvas");return}function sigmaBonds(a,e){var d,c,b;var f;for(d=1;d<=e;d++){f=element[molecule[d].atomicnumber].valence-countbonds(d);if(f>0){a[d][d]=f}for(c=0;c<molecule[d].bonds.length;c++){b=molecule[d].bonds[c];if(b>0){a[d][b]=2;a[b][d]=2}}}return a}function checkOctet(a,e){var d,c,b;for(d=1;d<=e;d++){(element[molecule[d].atomicnumber].valence>2)?b=8:b=2;for(c=1;c<=e;c++){b-=a[d][c]}if(b<0){b=0}a[0][d]=b}return a}function limitShare(b,e){var d,c,a;for(d=1;d<=e;d++){if(b[0][d]>0){a=0;for(c=0;c<molecule[d].bonds.length;c++){k=molecule[d].bonds[c];if(b[0][k]>0){a++}}(a>0)?b[0][d]=b[0][d]/a:b[0][d]=0;if(b[0][d]>2){b[0][d]=2}}}return b}function formPi(b,e){var d,c,a;for(d=1;d<=e;d++){if(b[0][d]>0){for(c=0;c<molecule[d].bonds.length;c++){k=molecule[d].bonds[c];if(k>d){octet=Math.min(b[0][d],b[0][k]);if(octet>0){b[d][k]+=2*octet;b[k][d]+=2*octet;b[d][d]-=octet;b[k][k]-=octet}}}}}return b}function formDative(g,m){var c,b,a,d;var e;var l=new Array();for(c=1;c<=m;c++){l[c]=0}for(c=1;c<=m;c++){if(g[0][c]>0){d=0;for(b=0;b<molecule[c].bonds.length;b++){a=molecule[c].bonds[b];if(a>0){if(g[a][a]>0){d++}}}if(d>0){g[0][c]=g[0][c]/d;for(b=0;b<molecule[c].bonds.length;b++){a=molecule[c].bonds[b];if(a>0){if(g[a][a]>0){l[a]+=g[0][c]}}}}}}e=1;for(c=1;c<=m;c++){if(l[c]>g[c][c]){e=0}}if(e>0){for(c=1;c<=m;c++){if(g[0][c]>0){for(b=0;b<molecule[c].bonds.length;b++){a=molecule[c].bonds[b];if(a>0){if(l[a]>0){g[c][a]+=g[0][c];g[a][c]+=g[0][c];g[a][a]-=g[0][c]}}}}}}var h,f;h="<p><b>Share:</b>";f="<p><b>Donor:</b>";for(c=1;c<=m;c++){if(g[0][c]>0){h+=" ["+c+"] needs "+g[0][c]+","}if(l[c]>0){f+=" ["+c+"] gives "+l[c]+","}}h+="</p>";f+="</p>";return g}function atomicCharge(s,t){var b=0.5;var n=0.5;var g=15;var p=0.001;var l,h,m;var f,e;var d,u,o;var a=new Array();var c=document.getElementById("qcinfo");e=n;for(l=1;l<=t;l++){f=molecule[l].atomicnumber;if((element[f].block=="d")||(element[f].block=="f")){e=0}d=element[f].EN||0;if(d==0){d=1;c.value+="WARNING: No electronegativity defined for ";c.value+=element[molecule[l].atomicnumber].symbol+"\n"}a[l]=d}m=0;o=100;while((m<g)&&(o>p)){m++;for(l=1;l<=t;l++){f=molecule[l].atomicnumber;d=e*(element[f].valence-s[l][l]);for(h=0;h<molecule[l].bonds.length;h++){k=molecule[l].bonds[h];if(k>0){d+=(1-e)*0.5*s[l][k];d-=s[l][k]*a[l]/(a[l]+a[k])}}molecule[l].charge=d}o=0;for(l=1;l<=t;l++){d=a[l];a[l]=element[molecule[l].atomicnumber].EN||1;a[l]+=b*molecule[l].charge;u=Math.abs(d-a[l]);if(u>o){o=u}}}return s}function dipole(g){var e;var d,c,a,f;var b=4.8032;d=0;c=0;a=0;for(e=1;e<=g;e++){d+=molecule[e].x*molecule[e].charge;c+=molecule[e].y*molecule[e].charge;a+=molecule[e].z*molecule[e].charge}f=b*Math.sqrt(d*d+c*c+a*a);return f}function showBondMatrix(f,g,l){var c,b;var n,e;var a,d;var h=new Array();var m=new Array();d=dipole(l);g.innerHTML="<h3>Dipole &approx; "+d.toFixed(1)+" D</h3>";g.innerHTML+="<h3>Bond Matrix</h3>";h="<table>";h+="<tr><td>&nbsp;</td>";for(c=1;c<=l;c++){h+="<td><strong>"+element[molecule[c].atomicnumber].symbol+"</strong></td>"}h+="<td><strong>Charge</strong></td>";h+="</tr>";for(c=1;c<=l;c++){h+="<tr><td><strong>"+element[molecule[c].atomicnumber].symbol+"</strong></td>";for(b=1;b<=l;b++){e=" ";a=f[c][b]-Math.floor(f[c][b]);if(a!=0){e="+"}n=Math.floor(f[c][b]);if(f[c][b]==0){n="."}if(c==b){m="<td><b>"+n+e+"</b> </td>"}else{m="";e=" ";a=f[c][b]/2-Math.floor(f[c][b]/2);if(a!=0){e="+"}a=Math.floor(f[c][b]/2);if(a==0){m="<td>."+e+"</td>"}if(a==1){m="<td>S"+e+"</td>"}if(a==2){m="<td>D"+e+"</td>"}if(a==3){m="<td>T"+e+"</td>"}if(m==""){h+="<td>"+Math.floor(f[c][b])+e+"</td>"}}h+=m}h+="<td><strong>"+molecule[c].charge.toFixed(2)+"</strong> </td>";h+="</tr>"}h+="</table>";g.innerHTML+=h}function mechanics(){var s,q,p;var b;var v;var h,g;var t=document.getElementById("qcinfo");var a=new Array();var o=new Array();var l="molcanvas";var d=document.getElementById(l);var n=d.getContext("2d");var m=d.width;var e=0.2;var u=500;var f=2e-7;Undo("save");t.value="Simple Geometry Optimization starting\n";geomLabel(n,"Simple Geometry Optimization started",m);a=hybridization();var c=0;if(c>0){t.value+="Hybridization\n";for(s=1;s<=molecule[0].numatoms;s++){b=molecule[s].atomicnumber;t.value+=element[b].symbol+" has "+a[s].hybrid+" hybrid orbitals\n"}}h=mechEnergy(a);a[0].energy=h;a[0].step=e;o[0]=new energyObject();o[0].energy=a[0].energy;o[0].step=a[0].step;for(s=1;s<=molecule[0].numatoms;s++){o[s]=new mechanicsObject();o[s].hybrid=a[s].hybrid;o[s].numbonds=a[s].numbonds;o[s].x=a[s].x;o[s].y=a[s].y;o[s].z=a[s].z}v=0;g=f*2;t.value+=0+": Energy = "+h.toFixed(8)+"\n";while((v<u)&&(g>f)){o=optimize(a);g=Math.abs(a[0].energy-o[0].energy);if(o[0].step>e){o[0].step=e}a[0].energy=o[0].energy;a[0].step=o[0].step;for(s=1;s<=molecule[0].numatoms;s++){a[s].hybrid=o[s].hybrid;a[s].numbonds=o[s].numbonds;a[s].x=o[s].x;a[s].y=o[s].y;a[s].z=o[s].z}v++;if(v<3){if(g<f){g=f*2}}if(g<f){if(o[0].step<e){a[0].step*=1.5;o=optimize(a);g=Math.abs(a[0].energy-o[0].energy);if(g>f){a[0].energy=o[0].energy;a[0].step=o[0].step;for(s=1;s<=molecule[0].numatoms;s++){a[s].hybrid=o[s].hybrid;a[s].numbonds=o[s].numbonds;a[s].x=o[s].x;a[s].y=o[s].y;a[s].z=o[s].z}}}}t.value+=v+": Energy = "+o[0].energy.toFixed(8)+"\n";c=1;if((c>0)&&(v%5==0)){for(s=1;s<=molecule[0].numatoms;s++){molecule[s].x=o[s].x;molecule[s].y=o[s].y;molecule[s].z=o[s].z}centerMolecule("molcanvas");drawMolecule("molcanvas");geomLabel(n,"Simple Geometry Optimization in progress.",m)}}t.value+="Final Energy at loop "+v+" = "+o[0].energy.toFixed(8)+"\n";t.value+="Geometry Optimization complete.\n";if(v>=u){t.value+="Too many steps. Optimization may not be complete.\n"}for(s=1;s<=molecule[0].numatoms;s++){molecule[s].x=o[s].x;molecule[s].y=o[s].y;molecule[s].z=o[s].z}centerMolecule("molcanvas");drawMolecule("molcanvas")}function mechanicsObject(){this.hybrid=0;this.numbonds=0;this.x=0;this.y=0;this.z=0}function energyObject(){this.energy=0;this.rstep=0;this.astep=0}function countbonds(c){var a,d,b=0;d=molecule[c].bonds.length;for(a=0;a<d;a++){if(molecule[c].bonds[a]>0){b++}}return b}function distance(f,g,e){var c=f[g].x-f[e].x;var b=f[g].y-f[e].y;var a=f[g].z-f[e].z;var d=Math.sqrt(c*c+b*b+a*a);return d}function angle(f,m,l,h){var p=f[m].x-f[l].x;var o=f[m].y-f[l].y;var n=f[m].z-f[l].z;var b=Math.sqrt(p*p+o*o+n*n);var g=f[h].x-f[l].x;var e=f[h].y-f[l].y;var d=f[h].z-f[l].z;var a=Math.sqrt(g*g+e*e+d*d);var c=(p*g+o*e+n*d)/(b*a);if(c>1){c=1}if(c<-1){c=-1}c=Math.acos(c)*180/Math.PI;return c}function dihedral(t,g,e,c,a){var s,q,p;var o,n,m;var z,x,v;var l,y,w,u;var h,f,d,b;o=t[g].x-t[e].x;n=t[g].y-t[e].y;m=t[g].z-t[e].z;z=t[c].x-t[e].x;x=t[c].y-t[e].y;v=t[c].z-t[e].z;y=n*v-m*x;w=m*z-o*v;u=o*x-n*z;l=Math.sqrt(y*y+w*w+u*u);o=t[a].x-t[c].x;n=t[a].y-t[c].y;m=t[a].z-t[c].z;f=m*x-n*v;d=o*v-m*z;b=n*z-o*x;h=Math.sqrt(f*f+d*d+b*b);ang=(-y*f-w*d-u*b)/(l*h);if(ang>1){ang=1}if(ang<-1){ang=-1}ang=Math.acos(ang)*180/Math.PI;return ang}function hybridization(){var d,c,b;var g;var h,e;var a=new Array();a[0]=new energyObject();a[0].energy=0;a[0].step=0;for(d=1;d<=molecule[0].numatoms;d++){a[d]=new mechanicsObject();a[d].hybrid=0;a[d].numbonds=countbonds(d);a[d].x=molecule[d].x;a[d].y=molecule[d].y;a[d].z=molecule[d].z}for(d=1;d<=molecule[0].numatoms;d++){g=element[molecule[d].atomicnumber].valence;switch(g){case 1:case 2:case 3:a[d].hybrid=a[d].numbonds;break;default:a[d].hybrid=g+a[d].numbonds-4;break}while((a[d].hybrid>a[d].numbonds)&&(a[d].hybrid>=5)){a[d].hybrid=a[d].hybrid-1}}var f=document.getElementById("qcinfo");for(d=1;d<=molecule[0].numatoms;d++){if((a[d].hybrid==4)&&(a[d].numbonds<4)){h=molecule[d].bonds.length;for(c=0;c<h;c++){b=molecule[d].bonds[c];if(b>0){if(a[b].hybrid==3){a[d].hybrid=3}}}}}return a}function mechEnergy(v){var d=document.getElementById("qcinfo");var J,I,H;var z,L,K,C,t;var o,n,m;var e,c,b,F,g;var O,M,B;var s,y,x,w;var q,l,h,f;var E;var a=Math.acos(-1/3)*180/Math.PI;var u=0;var d=document.getElementById("qcinfo");var G=20000;var P=10;var N=5;var D=500;DEBUG=1;if(DEBUG>0){var p=0;for(J=1;J<=molecule[0].numatoms;J++){p+=v[J].hybrid}if(p<molecule[0].numatoms){d.value+="*** Too few hybrid orbitals ("+p+") returned at end of optimize\n"}}for(J=1;J<=molecule[0].numatoms;J++){n=element[molecule[J].atomicnumber].radius;if(v[J].hybrid==3){n-=0.05}if(v[J].hybrid==2){n-=0.1}B=molecule[J].bonds.length;for(I=0;I<B;I++){H=molecule[J].bonds[I];if(H>0){m=element[molecule[H].atomicnumber].radius;if(v[H].hybrid==3){m-=0.05}if(v[H].hybrid==2){m-=0.1}o=n+m;e=v[J].x-v[H].x;c=v[J].y-v[H].y;b=v[J].z-v[H].z;F=Math.sqrt(e*e+c*c+b*b);u+=G*(F-o)*(F-o)}}}for(J=1;J<=molecule[0].numatoms;J++){if(v[J].hybrid>1){B=molecule[J].bonds.length;for(I=0;I<(B-1);I++){O=molecule[J].bonds[I];if(O>0){y=v[O].x-v[J].x;x=v[O].y-v[J].y;w=v[O].z-v[J].z;s=Math.sqrt(y*y+x*x+w*w);for(H=I+1;H<B;H++){M=molecule[J].bonds[H];if(M>0){l=v[M].x-v[J].x;h=v[M].y-v[J].y;f=v[M].z-v[J].z;q=Math.sqrt(l*l+h*h+f*f);E=(y*l+x*h+w*f)/(s*q);if(E>1){E=1}if(E<-1){E=-1}E=Math.acos(E)*180/Math.PI;switch(v[J].hybrid){case 2:u+=P*(E-180)*(E-180);break;case 3:u+=P*(E-120)*(E-120);break;case 4:u+=P*(E-a)*(E-a);break;case 5:case 6:if(E<100){u+=P*(E-90)*(E-90)}break}}}}}}}for(J=1;J<molecule[0].numatoms;J++){if(v[J].hybrid==4){for(z=0;z<molecule[J].bonds.length;z++){I=molecule[J].bonds[z];if((I>J)&&(v[I].hybrid==4)){for(L=0;L<molecule[J].bonds.length;L++){C=molecule[J].bonds[L];if((C>0)&&(C!=I)){for(K=0;K<molecule[I].bonds.length;K++){t=molecule[I].bonds[K];if((t>0)&&(t!=J)){E=Math.abs(dihedral(v,C,J,I,t));while(E>120){E-=120}u+=N*(E-60)*(E-60)}}}}}}}}for(J=1;J<molecule[0].numatoms;J++){if(v[J].hybrid==3){for(z=0;z<molecule[J].bonds.length;z++){I=molecule[J].bonds[z];if((I>J)&&(v[I].hybrid==3)){for(L=0;L<molecule[J].bonds.length;L++){C=molecule[J].bonds[L];if((C>0)&&(C!=I)){for(K=0;K<molecule[I].bonds.length;K++){t=molecule[I].bonds[K];if((t>0)&&(t!=J)){E=Math.abs(dihedral(v,C,J,I,t));if(E>180){E-=180}if(E>135){E=180-E}u+=N*E*E}}}}}}}}for(J=1;J<molecule[0].numatoms;J++){n=element[molecule[J].atomicnumber].radius;for(I=J+1;I<=molecule[0].numatoms;I++){m=element[molecule[I].atomicnumber].radius;F=distance(v,J,I);if(F<0.1){F=0.1}F=F/(n+m);u+=D/(F*F*F*F*F*F)}}return u}function changexyz(m){var w=document.getElementById("qcinfo");var v,t,q;var h,y;var c,g,f,e;var o,n,l;var a;var u,s,p;var x;var z=m[0].step;var b=0;if(b>0){w.value+="Hybridization\n";for(v=1;v<=molecule[0].numatoms;v++){Z=molecule[v].atomicnumber;w.value+=element[Z].symbol+" has "+m[v].hybrid+" hybrid orbitals\n"}}var y=new Array();for(v=0;v<=molecule[0].numatoms;v++){y[v]=[0,0,0]}var d=new Array();d[0]=new energyObject();d[0].energy=m[0].energy;d[0].step=m[0].step;for(v=1;v<=molecule[0].numatoms;v++){d[v]=new mechanicsObject();d[v].hybrid=m[v].hybrid;d[v].numbonds=m[v].numbonds;d[v].x=m[v].x;d[v].y=m[v].y;d[v].z=m[v].z}c=mechEnergy(d);for(v=1;v<=molecule[0].numatoms;v++){u=d[v].x;s=d[v].y;p=d[v].z;for(h=0;h<6;h++){o=0;n=0;l=0;g=c;f=c;e=c;(h%2)?a=1:a=-1;switch(h){case 0:case 1:d[v].x=u+a*z;Energy=mechEnergy(d);while((Energy>c)&&(a>0.1)){a*=0.75;d[v].x=u+a*z;Energy=mechEnergy(d)}if(Energy<g){o=a}d[v].x=u;y[v][0]=o*z;break;case 2:case 3:d[v].y=s+a*z;Energy=mechEnergy(d);while((Energy>c)&&(a>0.1)){a*=0.75;d[v].y=s+a*z;Energy=mechEnergy(d)}if(Energy<f){n=a}d[v].y=s;y[v][1]=n*z;break;case 4:case 5:d[v].z=p+a*z;Energy=mechEnergy(d);while((Energy>c)&&(a>0.1)){a*=0.75;d[v].z=p+a*z;Energy=mechEnergy(d)}if(Energy<e){l=a}d[v].z=p;y[v][2]=l*z;break}}}return y}function optimize(m){var u=document.getElementById("qcinfo");var t,s,q;var n;var h;var c;var d;var w,f;var l;var v=new Array();var p=new Array();var a=0.001;var e=m[0].step;var b=m[0].energy;DEBUG=1;if(DEBUG>0){var g=mechEnergy(m);if(g!=b){u.value+="*** Call to mechEnergy changed energy from "+b+" to "+g+"\n"}var o=0;for(t=1;t<=molecule[0].numatoms;t++){o+=m[t].hybrid}if(o<molecule[0].numatoms){u.value+="*** Too few hybrid orbitals ("+o+")\n"}}for(t=0;t<=molecule[0].numatoms;t++){v[t]=[0,0,0]}v=changexyz(m);l=0;for(t=0;t<=molecule[0].numatoms;t++){for(s=0;s<3;s++){if(Math.abs(v[t][s])>l){l=Math.abs(v[t][s])}}}d=m[0].energy;w=0;f=1;c=trialEnergy(m,v,f);while((c>d)&&(f>0.002)){f*=0.75;c=trialEnergy(m,v,f)}if(c<d){w=f;d=c}h=(w+0.5)*(m[0].step+l);if(h<a){h=a}p[0]=new energyObject();p[0].energy=d;p[0].step=h;for(t=1;t<=molecule[0].numatoms;t++){p[t]=new mechanicsObject();p[t].hybrid=m[t].hybrid;p[t].numbonds=m[t].numbonds;p[t].x=m[t].x+w*v[t][0];p[t].y=m[t].y+w*v[t][1];p[t].z=m[t].z+w*v[t][2]}DEBUG=0;if(DEBUG>0){for(t=0;t<=molecule[0].numatoms;t++){u.value+="Change in coordinates = (";for(s=0;s<3;s++){u.value+=v[t][s].toFixed(5);if(s<2){u.value+=", "}}u.value+=")\n"}u.value+="--- Max change = "+l.toFixed(5)+"\n"}return(p)}function trialEnergy(d,e,b){var a;var c=new Array();c[0]=new energyObject();c[0].energy=d[0].energy;c[0].step=d[0].step;for(a=1;a<=molecule[0].numatoms;a++){c[a]=new mechanicsObject();c[a].hybrid=d[a].hybrid;c[a].numbonds=d[a].numbonds;c[a].x=d[a].x+b*e[a][0];c[a].y=d[a].y+b*e[a][1];c[a].z=d[a].z+b*e[a][2]}return mechEnergy(c)};